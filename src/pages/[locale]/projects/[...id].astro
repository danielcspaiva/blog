---
import { getCollection, render } from "astro:content";
import PostHogLayout from "@layouts/PostHogLayout.astro";
import Layout from "@layouts/Layout.astro";
import Container from "@components/Container.astro";
import FormattedDate from "@components/FormattedDate.astro";
import { readingTime } from "@lib/utils";
import BackToPrevious from "@components/BackToPrevious.astro";
import Link from "@components/Link.astro";
import TableOfContents from "@components/TableOfContents.astro";
import { useTranslations } from "../../../i18n/utils";
import { languages, ui } from "../../../i18n/ui";
import { getSlugFromId, getLocalizedProject, type Project } from "../../../i18n/projects";

export async function getStaticPaths() {
  const projects = await getCollection("projects") as Project[];
  const locales = Object.keys(languages);

  // Get unique slugs (project identifiers) to generate paths
  const slugs = [...new Set(projects.map(project => getSlugFromId(project.id)))];

  return slugs.flatMap(slug => {
    return locales.map(locale => {

      // Find the appropriate project for this locale and slug
      const project = getLocalizedProject(projects, slug, locale);

      // If no project is found for this locale, skip it
      if (!project) return null;

      return {
        params: {
          locale,
          id: slug
        },
        props: {
          project,
          locale
        }
      };
    }).filter(Boolean); // Filter out null entries
  });
}

const { project, locale } = Astro.props;
const lang = locale as keyof typeof ui;
const { Content, headings } = await render(project);

// Content based on locale
const content = {
  en: {
    backToProjects: "Back to projects",
  },
  "pt-br": {
    backToProjects: "Voltar para projetos",
  },
};

const pageContent = content[lang];
---

<PostHogLayout>
  <Layout title={project.data.title} description={project.data.description}>
    <Container>
      <div class="animate">
        <BackToPrevious href={`/${locale}/projects`}
          >{pageContent.backToProjects}</BackToPrevious
        >
      </div>
      <div class="animate my-10 space-y-1">
        <div class="flex items-center gap-1.5">
          <div class="font-base text-sm">
            <FormattedDate date={project.data.date} />
          </div>
          &bull;
          {
            project.body && (
              <div class="font-base text-sm">{readingTime(project.body)}</div>
            )
          }
        </div>
        <h1 class="text-3xl font-semibold text-black dark:text-white">
          {project.data.title}
        </h1>
        {
          (project.data.demoURL || project.data.repoURL) && (
            <nav class="flex gap-1">
              {project.data.demoURL && (
                <Link href={project.data.demoURL} external>
                  demo
                </Link>
              )}
              {project.data.demoURL && project.data.repoURL && <span>/</span>}
              {project.data.repoURL && (
                <Link href={project.data.repoURL} external>
                  repo
                </Link>
              )}
            </nav>
          )
        }
      </div>
      <TableOfContents headings={headings} />
      <article class="animate">
        <Content />
      </article>
    </Container>
  </Layout>
</PostHogLayout>
